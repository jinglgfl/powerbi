<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>LGfL Support Site BI Stats</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/powerbi-client/dist/powerbi.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #111217;
            color: white;
            font-family: Arial, sans-serif;
        }
        #reportContainer {
            width: 100vw;
            height: 100vh;
        }
        #loginButton {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            background: #0078d7;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 14px;
            border-radius: 4px;
            z-index: 1000;
        }
        iframe {
            border:0 !important;}
    </style>
</head>
<body>

<button id="loginButton" style="display: none;">Sign In</button>
<div id="reportContainer"></div>

<script>
    const msalConfig = {
        auth: {
            clientId: "126b1e36-bd92-431a-b49f-c75397c1ab9e",
            redirectUri: "https://jinglgfl.github.io/powerbi/",
            authority: "https://login.microsoftonline.com/f1093b3c-cd4b-425b-bce8-b5c5dac62269"
        }
    };

    const powerBiScopes = ["https://analysis.windows.net/powerbi/api/Report.Read.All"];

    const reportId = "d18f0783-b15b-4f2d-b3de-44dab4d14daf";
    const groupId = "20e6d339-83d1-4f87-8366-cea0568d16ee";

    const msalInstance = new msal.PublicClientApplication(msalConfig);

    const loginButton = document.getElementById("loginButton");
    const reportContainer = document.getElementById("reportContainer");

    let embeddedReport = null;
    let reportRefreshIntervalId = null;

    /**
     * This function is the accessTokenProvider for Power BI Embedded.
     * It's called by the Power BI SDK when it needs a new access token (e.g., current one is expiring).
     * It should ideally only perform silent token acquisition.
     */
    async function getNewAccessToken() {
        try {
            const account = msalInstance.getActiveAccount();
            if (!account) {
                console.error("AccessTokenProvider: No active MSAL account found for silent token refresh.");
                // Ensure we throw a defined error object
                throw new Error("AccessTokenProvider: No active account for silent token renewal.");
            }

            const response = await msalInstance.acquireTokenSilent({
                scopes: powerBiScopes,
                account: account,
                // Add this if you suspect caching issues, but generally not needed for silent renewal.
                // forceRefresh: true,
            });
            console.log("AccessTokenProvider: Token refreshed silently.");
            return response.accessToken;
        } catch (error) {
            console.error("AccessTokenProvider: Error acquiring new token silently:", error);
            // Ensure we re-throw a defined error object
            throw new Error(`AccessTokenProvider: Token acquisition failed: ${error.message || error}`);
        }
    }

    /**
     * Embeds the Power BI report. Requires an initial accessToken.
     * The accessTokenProvider handles subsequent token renewals automatically.
     */
    function embedReport(initialAccessToken) {
        powerbi.reset(reportContainer);

        if (reportRefreshIntervalId) {
            clearInterval(reportRefreshIntervalId);
            reportRefreshIntervalId = null;
        }

        const embedUrl = `https://app.powerbi.com/reportEmbed?reportId=${reportId}&groupId=${groupId}`;
        const models = window["powerbi-client"].models;

        const embedConfig = {
            type: "report",
            id: reportId,
            embedUrl: embedUrl,
            accessToken: initialAccessToken,
            tokenType: models.TokenType.Aad,
            settings: {
                filterPaneEnabled: false,
                navContentPaneEnabled: false,
                background: models.BackgroundType.Transparent,
                layoutType: models.LayoutType.Custom,
                customLayout: {
                    displayOption: models.DisplayOption.FitToPage,
                },
            },
            accessTokenProvider: getNewAccessToken
        };

        // Assign the embedded report to the global variable
        embeddedReport = powerbi.embed(reportContainer, embedConfig);

        // Add a .catch() to the embed operation itself for direct rejections
        // While Power BI SDK typically uses events, defensive .catch() is good
        Promise.resolve(embeddedReport)
            .then(report => {
                // Ensure embeddedReport is properly assigned before listeners
                embeddedReport = report; // This line might be redundant but harmless after powerbi.embed
            })
            .catch(error => {
                console.error('Power BI Embed Promise Rejected:', error);
                loginButton.style.display = "inline-block";
                powerbi.reset(reportContainer);
                if (reportRefreshIntervalId) {
                    clearInterval(reportRefreshIntervalId);
                    reportRefreshIntervalId = null;
                }
            });


        embeddedReport.on('loaded', () => {
            console.log('Report loaded successfully.');
            // Start a separate interval for refreshing report visuals if needed
            reportRefreshIntervalId = setInterval(async () => {
                try {
                    if (embeddedReport) {
                        await embeddedReport.refresh();
                        console.log('Report visuals refreshed.');
                    }
                } catch (err) {
                    console.error('Error refreshing report visuals:', err);
                    // Decide if a visual refresh error should trigger a re-login
                    // For now, just log and continue, unless it's a critical auth error.
                }
            }, 300000); // 5 minutes (adjust as needed)
        });

        // Enhanced error listener for the embedded report
        embeddedReport.on('error', (event) => {
            console.error('Power BI Embedded Report Error Event:', event.detail);
            // This event catches errors that happen *within* the embedded report iframe
            // (e.g., token expired, permissions issue, report data error).
            loginButton.style.display = "inline-block";
            powerbi.reset(reportContainer);
            if (reportRefreshIntervalId) {
                clearInterval(reportRefreshIntervalId);
                reportRefreshIntervalId = null;
            }
        });
    }

    /**
     * Attempts to acquire a token silently. If silent fails, falls back to a popup.
     * This is used for initial login/token acquisition, not for background token renewal.
     */
    async function acquireTokenSilentOrPopup(account) {
        try {
            const response = await msalInstance.acquireTokenSilent({
                scopes: powerBiScopes,
                account: account,
            });
            console.log("MSAL: Silent token acquired for initial embed.");
            return response.accessToken;
        } catch (silentError) {
            console.warn("MSAL: Silent token acquisition failed for initial embed, falling back to popup.", silentError);
            try {
                const response = await msalInstance.acquireTokenPopup({
                    scopes: powerBiScopes,
                });
                console.log("MSAL: Popup token acquired for initial embed.");
                return response.accessToken;
            } catch (popupError) {
                console.error("MSAL: Popup token acquisition failed:", popupError);
                throw popupError; // Re-throw to propagate the error
            }
        }
    }

    /**
     * Handles the sign-in process, primarily using loginPopup.
     */
    async function signIn() {
        try {
            const loginResponse = await msalInstance.loginPopup({
                scopes: powerBiScopes,
            });
            console.log("MSAL: Login success:", loginResponse);

            loginButton.style.display = "none";

            const account = loginResponse.account;
            msalInstance.setActiveAccount(account);

            const accessToken = await acquireTokenSilentOrPopup(account);
            embedReport(accessToken);
        } catch (error) {
            console.error("SIGN_IN_PROCESS_ERROR: Login or initial token acquisition failed:", error);
            alert("Login failed. See console for details.");
            loginButton.style.display = "inline-block";
        }
    }

    loginButton.addEventListener("click", signIn);

    window.onload = async () => {
        const accounts = msalInstance.getAllAccounts();
        if (accounts.length > 0) {
            msalInstance.setActiveAccount(accounts[0]);
            try {
                const accessToken = await acquireTokenSilentOrPopup(accounts[0]);
                loginButton.style.display = "none";
                embedReport(accessToken);
            } catch (error) {
                console.warn("WINDOW_ONLOAD_ERROR: Could not acquire token for existing account on load, prompting full sign-in.", error);
                loginButton.style.display = "inline-block";
                powerbi.reset(reportContainer);
                // Attempt to sign in again if silent acquisition failed for existing account
                try {
                    await signIn();
                } catch (reSignInError) {
                    console.error("WINDOW_ONLOAD_ERROR: Secondary sign-in attempt failed:", reSignInError);
                    alert("Failed to auto-sign in. Please try manually or check console.");
                }
            }
        } else {
            // No existing accounts found, attempt to sign in immediately.
            try {
                await signIn();
            } catch (error) {
                console.error("WINDOW_ONLOAD_ERROR: Auto sign-in failed on page load (no accounts):", error);
                loginButton.style.display = "inline-block";
            }
        }
    };
</script>

</body>
</html>
