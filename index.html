<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Power BI Embed with Azure AD Login</title>
  <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/powerbi-client/dist/powerbi.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #111217;
      color: white;
      font-family: Arial, sans-serif;
    }
    #reportContainer {
      width: 100vw;
      height: 100vh;
    }
    #loginButton {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 16px;
      background: #0078d7;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 14px;
      border-radius: 4px;
      z-index: 1000;
    }
  </style>
</head>
<body>

<button id="loginButton">Sign In</button>

<div id="reportContainer"></div>

<script>
  // === Config - Replace these values with your own ===
  const msalConfig = {
    auth: {
      clientId: "126b1e36-bd92-431a-b49f-c75397c1ab9e",
      redirectUri: "https://jinglgfl.github.io/powerbi/",
      authority: "https://login.microsoftonline.com/f1093b3c-cd4b-425b-bce8-b5c5dac62269"
    }
  };

  const powerBiScopes = ["https://analysis.windows.net/powerbi/api/Report.Read.All"];

  // Power BI Report info
  const reportId = "d18f0783-b15b-4f2d-b3de-44dab4d14daf";
  const groupId = "20e6d339-83d1-4f87-8366-cea0568d16ee";

  // === Initialize MSAL ===
  const msalInstance = new msal.PublicClientApplication(msalConfig);

  const loginButton = document.getElementById("loginButton");
  const reportContainer = document.getElementById("reportContainer");

  let embeddedReport = null;  // Will hold the embedded report object
  let refreshIntervalId = null; // Store interval ID so we could clear if needed

  // === Helper: embed report with access token ===
  function embedReport(accessToken) {
    // Reset existing report and clear any prior interval
    powerbi.reset(reportContainer);
    if (refreshIntervalId) {
      clearInterval(refreshIntervalId);
      refreshIntervalId = null;
    }

    const embedUrl = `https://app.powerbi.com/reportEmbed?reportId=${reportId}&groupId=${groupId}`;
    const models = window["powerbi-client"].models;

    const embedConfig = {
      type: "report",
      id: reportId,
      embedUrl: embedUrl,
      accessToken: accessToken,
      tokenType: models.TokenType.Aad,
      settings: {
        filterPaneEnabled: false,
        navContentPaneEnabled: false,
        background: models.BackgroundType.Transparent,
        layoutType: models.LayoutType.Custom,
        customLayout: {
          displayOption: models.DisplayOption.FitToPage,
        },
      },
    };

    // Embed the report and keep the reference
    embeddedReport = powerbi.embed(reportContainer, embedConfig);

    // Attach event handlers
    embeddedReport.on('loaded', function() {
      console.log('Report loaded');
    });

    embeddedReport.on('error', function(event) {
      console.error(event.detail);
    });

    // Refresh visuals every 30 seconds
    refreshIntervalId = setInterval(() => {
      embeddedReport.refresh()
        .then(() => console.log('Report refreshed'))
        .catch(error => console.error('Error refreshing report:', error));
    }, 30000);
  }

  // === Sign in the user and get token ===
  async function signIn() {
    try {
      const loginResponse = await msalInstance.loginPopup({
        scopes: powerBiScopes,
      });

      console.log("Login success:", loginResponse);

      loginButton.style.display = "none";

      const account = loginResponse.account;
      msalInstance.setActiveAccount(account);

      const tokenResponse = await msalInstance.acquireTokenSilent({
        scopes: powerBiScopes,
        account: account,
      });

      console.log("Token acquired silently:", tokenResponse.accessToken);

      embedReport(tokenResponse.accessToken);
    } catch (error) {
      console.error("Login or token acquisition failed:", error);
      alert("Login failed. See console for details.");
    }
  }

  // === Wire up button ===
  loginButton.addEventListener("click", signIn);

  // === On page load, check if user is already signed in ===
  window.onload = async () => {
    const accounts = msalInstance.getAllAccounts();
    if (accounts.length > 0) {
      msalInstance.setActiveAccount(accounts[0]);
      try {
        const tokenResponse = await msalInstance.acquireTokenSilent({
          scopes: powerBiScopes,
          account: accounts[0],
        });
        loginButton.style.display = "none";
        embedReport(tokenResponse.accessToken);
      } catch {
        // Token silent acquisition failed - user interaction needed
        loginButton.style.display = "inline-block";
      }
    }
  };
</script>

</body>
</html>
