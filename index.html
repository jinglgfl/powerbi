<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>LGfL Support Site BI Statss</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/powerbi-client/dist/powerbi.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #111217;
            color: white;
            font-family: Arial, sans-serif;
        }
        #reportContainer {
            width: 100vw;
            height: 100vh;
        }
        #loginButton {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            background: #0078d7;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 14px;
            border-radius: 4px;
            z-index: 1000;
        }
        iframe {
            border:0 !important;}
    </style>
</head>
<body>

<button id="loginButton" style="display: none;">Sign In</button>
<div id="reportContainer"></div>

<script>
    const msalConfig = {
        auth: {
            clientId: "126b1e36-bd92-431a-b49f-c75397c1ab9e",
            redirectUri: "https://jinglgfl.github.io/powerbi/",
            authority: "https://login.microsoftonline.com/f1093b3c-cd4b-425b-bce8-b5c5dac62269"
        }
    };

    const powerBiScopes = ["https://analysis.windows.net/powerbi/api/Report.Read.All"];

    const reportId = "d18f0783-b15b-4f2d-b3de-44dab4d14daf";
    const groupId = "20e6d339-83d1-4f87-8366-cea0568d16ee";

    const msalInstance = new msal.PublicClientApplication(msalConfig);

    const loginButton = document.getElementById("loginButton");
    const reportContainer = document.getElementById("reportContainer");

    let embeddedReport = null;
    let reportRefreshIntervalId = null; // Renamed to clarify its purpose for report visuals

    /**
     * This function is the accessTokenProvider for Power BI Embedded.
     * It's called by the Power BI SDK when it needs a new access token (e.g., current one is expiring).
     * It should ideally only perform silent token acquisition.
     */
    async function getNewAccessToken() {
        try {
            const account = msalInstance.getActiveAccount();
            if (!account) {
                // This scenario indicates a problem: no active account for silent renewal.
                // It means the user's session might have completely expired.
                console.error("No active MSAL account found for silent token refresh in accessTokenProvider.");
                // You might throw an error to signal to the Power BI SDK that token acquisition failed.
                // The Power BI report might then display an error.
                throw new Error("No active account for silent token renewal.");
            }

            const response = await msalInstance.acquireTokenSilent({
                scopes: powerBiScopes,
                account: account,
            });
            console.log("Token refreshed by accessTokenProvider silently.");
            return response.accessToken;
        } catch (error) {
            console.error("Error acquiring new token silently in accessTokenProvider:", error);
            // Re-throw the error so the Power BI SDK knows the token refresh failed.
            throw error;
        }
    }

    /**
     * Embeds the Power BI report. The accessTokenProvider handles token renewals automatically.
     */
    function embedReport() {
        powerbi.reset(reportContainer);

        // Clear any existing report visual refresh interval before embedding a new report
        if (reportRefreshIntervalId) {
            clearInterval(reportRefreshIntervalId);
            reportRefreshIntervalId = null;
        }

        const embedUrl = `https://app.powerbi.com/reportEmbed?reportId=${reportId}&groupId=${groupId}`;
        const models = window["powerbi-client"].models;

        const embedConfig = {
            type: "report",
            id: reportId,
            embedUrl: embedUrl,
            accessToken: null, // Initial token will be handled by Power BI calling accessTokenProvider
            tokenType: models.TokenType.Aad,
            settings: {
                filterPaneEnabled: false,
                navContentPaneEnabled: false,
                background: models.BackgroundType.Transparent,
                layoutType: models.LayoutType.Custom,
                customLayout: {
                    displayOption: models.DisplayOption.FitToPage,
                },
            },
            // *** KEY CHANGE: Use accessTokenProvider for token renewals ***
            accessTokenProvider: getNewAccessToken
        };

        embeddedReport = powerbi.embed(reportContainer, embedConfig);

        embeddedReport.on('loaded', () => {
            console.log('Report loaded');
            // *** NEW: Start a separate interval for refreshing report visuals if needed ***
            // This interval is ONLY for refreshing the *visuals* of the report,
            // not for token management. Adjust the time based on your data refresh frequency.
            // Example: Refresh visuals every 5 minutes (300000 ms)
            reportRefreshIntervalId = setInterval(async () => {
                try {
                    if (embeddedReport) { // Ensure the report is still embedded
                        await embeddedReport.refresh();
                        console.log('Report visuals refreshed.');
                    }
                } catch (err) {
                    console.error('Error refreshing report visuals:', err);
                    // Handle visual refresh errors, e.g., if report is no longer valid
                }
            }, 300000); // 5 minutes (adjust as needed)
        });

        embeddedReport.on('error', (event) => {
            console.error('Power BI Embedded Error:', event.detail);
            // If there's an error during embed or runtime, display the login button
            loginButton.style.display = "inline-block";
            powerbi.reset(reportContainer); // Clear the report container
            // Also stop any ongoing visual refresh interval
            if (reportRefreshIntervalId) {
                clearInterval(reportRefreshIntervalId);
                reportRefreshIntervalId = null;
            }
        });
    }

    /**
     * Attempts to acquire a token silently. If silent fails, falls back to a popup.
     * This is used for initial login/token acquisition, not for background token renewal.
     */
    async function acquireTokenSilentOrPopup(account) {
        try {
            const response = await msalInstance.acquireTokenSilent({
                scopes: powerBiScopes,
                account: account,
            });
            console.log("Silent token acquired for initial embed.");
            return response.accessToken;
        } catch (silentError) {
            console.warn("Silent token acquisition failed for initial embed, falling back to popup.", silentError);
            // Only fall back to popup if it's the *initial* login attempt or a re-auth
            const response = await msalInstance.acquireTokenPopup({
                scopes: powerBiScopes,
            });
            console.log("Popup token acquired for initial embed.");
            return response.accessToken;
        }
    }

    /**
     * Handles the sign-in process, primarily using loginPopup.
     */
    async function signIn() {
        try {
            // Use loginPopup for initial interactive login
            const loginResponse = await msalInstance.loginPopup({
                scopes: powerBiScopes,
            });
            console.log("Login success:", loginResponse);

            loginButton.style.display = "none";

            const account = loginResponse.account;
            msalInstance.setActiveAccount(account);

            // You don't necessarily *need* to acquire the first token here and pass it.
            // The embed function will call accessTokenProvider immediately if accessToken is null.
            // However, explicitly acquiring it here ensures we have one before calling embed.
            const accessToken = await acquireTokenSilentOrPopup(account);
            embedReport(); // Now call embedReport without passing accessToken directly
        } catch (error) {
            console.error("Login or initial token acquisition failed:", error);
            alert("Login failed. See console for details.");
            loginButton.style.display = "inline-block"; // Ensure button is shown if login fails
        }
    }

    loginButton.addEventListener("click", signIn);

    window.onload = async () => {
        const accounts = msalInstance.getAllAccounts();
        if (accounts.length > 0) {
            msalInstance.setActiveAccount(accounts[0]);
            try {
                // Attempt to acquire token silently for existing account on load
                // If this fails, the user's session is likely expired and they need to re-authenticate.
                const accessToken = await acquireTokenSilentOrPopup(accounts[0]);
                loginButton.style.display = "none";
                embedReport();
            } catch (error) {
                console.warn("Could not acquire token for existing account on load, prompting full sign-in.", error);
                loginButton.style.display = "inline-block";
                // If silent acquisition fails for an existing account, reset Power BI and show login button
                powerbi.reset(reportContainer);
            }
        } else {
            // No existing accounts found, attempt to sign in immediately.
            try {
                await signIn(); // Call signIn to initiate the process (will use popup if needed)
            } catch (error) {
                console.error("Auto sign-in failed on page load:", error);
                loginButton.style.display = "inline-block"; // Show button if auto sign-in fails
            }
        }
    };
</script>

</body>
</html>
